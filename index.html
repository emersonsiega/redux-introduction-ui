<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Udacity Todos/Goals</title>
</head>
<body>
    
    <script type="text/javascript">
        /**
         * The store should have four parts:
         *  1. The state
         *  2. Get the state
         *  3. Listen to changes on the state
         *  4. Update the state
         * 
         * Rules:
         *  1. Just an event can change the state
         *  2. The function that returns the new state must be a pure function
        */
        const createStore = (reducer) => {
            let state
            let listeners = []

            const getState = () => state

            /**
             * Listen for changes on the state
            */
            const subscribe = (listener) => {
                listeners.push(listener)

                // returns an "unsubscribe" function
                return () => {
                    listeners = listeners.filter(l => l !== listener)
                }
            }

            /**
             * Call action to change state and notify all the listeners
            */
            const dispatch = (action) => {
                state = reducer(state, action)
                listeners.forEach(listener => listener())
            }

            return {
                getState,
                subscribe,
                dispatch
            }
        }

        /**
         * Todos
        */
        const ADD_TODO = 'ADD_TODO'
        const REMOVE_TODO = 'REMOVE_TODO'
        const TOGGLE_TODO = 'TOGGLE_TODO'

        const todosReducer = (state = [], action) => {
            switch (action.type) {
                case ADD_TODO:
                    return state.concat([action.todo])
                case REMOVE_TODO:
                    return state.filter(todo => todo.id !== action.id)
                case TOGGLE_TODO:
                    return state.map(todo => todo.id !== action.id ? todo :
                        Object.assign({}, todo, { complete: !todo.complete }))
                default:
                    return state
            }
        }

        const addTodoAction = todo => {
            return {
                type: ADD_TODO,
                todo
            }
        }

        const removeTodoAction = id => {
            return {
                type: REMOVE_TODO,
                id
            }
        }

        const toggleTodoAction = id => {
            return {
                type: TOGGLE_TODO,
                id
            }
        }

        /**
         * Goals
        */
        const ADD_GOAL = 'ADD_GOAL'
        const REMOVE_GOAL = 'REMOVE_GOAL'

        const goalsReducer = (state = [], action) => {
            switch (action.type) {
                case ADD_GOAL:
                    return state.concat([action.goal])
                case REMOVE_GOAL:
                    return state.filter(g => g.id !== action.id)
                default:
                    return state
            }
        }

        const addGoalAction = goal => {
            return {
                type: ADD_GOAL,
                goal
            }
        }

        const removeGoalAction = id => {
            return {
                type: REMOVE_GOAL,
                id
            }
        }

        /**
         * Main script. Create a root reducer to centralize all reducers
        */
        const rootReducer = (state = {}, action) => {
            return {
                todos: todosReducer(state.todos, action),
                goals: goalsReducer(state.goals, action)
            }
        }

        const store = createStore(rootReducer)
        store.subscribe(() => console.log(`State changed: \n`, store.getState()))

        store.dispatch(addTodoAction({
            id: 0,
            name: 'Learn Redux',
            complete: false
        }))

        store.dispatch(addTodoAction({
            id: 1,
            name: 'Be FODA in React',
            complete: false
        }))

        store.dispatch(addTodoAction({
            id: 2,
            name: 'Learn ES6',
            complete: true
        }))

        store.dispatch(removeTodoAction(1))

        store.dispatch(toggleTodoAction(2))

        store.dispatch(addGoalAction({
            id: 0,
            name: 'Learn Redux'
        }))

        store.dispatch(addGoalAction({
            id: 1,
            name: 'Lose 20 pounds'
        }))

        store.dispatch(removeGoalAction(0))

    </script>
</body>
</html>
